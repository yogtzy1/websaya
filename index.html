<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ndraa Syntax Pro 2.1 ‚Äî Ultimate IDE</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- CodeMirror 5 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>

<!-- Linting & Formatting -->
<script src="https://cdn.jsdelivr.net/npm/esprima@4.0.1/dist/esprima.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/htmlhint@0.13.1/dist/htmlhint.min.js"></script>
<script src="https://unpkg.com/stylelint@15.14.0/dist/stylelint.umd.js"></script>
<script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
<script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
<script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
<script src="https://unpkg.com/prettier@2.8.8/parser-postcss.js"></script>

<style>
html,body,#app{height:100%;margin:0;font-family:Inter,system-ui;}
body{background:linear-gradient(180deg,#071024 0%,#08102a 70%);color:#e6eef8;}
header,footer{padding:10px 20px;}
.glass{background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);border-radius:8px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}
.cm-container .CodeMirror{height:calc(100vh - 250px);border-radius:6px;}
.sidebar{width:260px;min-width:220px;}
.btn{padding:6px 10px;border-radius:6px;font-weight:600;cursor:pointer;}
.status-bar{padding:4px 10px;font-size:0.85rem;color:#94a3b8;display:flex;justify-content:space-between;}
.issue-error{color:#f87171;font-weight:600;}
.issue-warn{color:#facc15;font-weight:600;}
.issue-info{color:#38bdf8;font-weight:600;}
</style>
</head>
<body>
<div id="app" class="flex flex-col min-h-screen">
<header class="glass flex items-center justify-between m-4">
<div class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-cyan-400">Ndraa Syntax Pro 2.1</div>
<a href="https://whatsapp.com/channel/0029ValNqnPDOQIWQjHK6R0v" target="_blank" class="btn bg-green-500">Owner</a>
</header>

<main class="flex flex-1 gap-4 px-4 pb-4">
<aside class="sidebar glass p-4 flex flex-col gap-4">
<label class="text-xs">Language</label>
<select id="langSelect" class="p-2 bg-transparent border rounded">
<option value="javascript">JavaScript</option>
<option value="html">HTML</option>
<option value="css">CSS</option>
</select>

<label class="text-xs mt-2">Upload file</label>
<input id="fileInput" type="file" accept=".js,.jsx,.html,.htm,.css" class="mt-1 text-xs w-full" />

<div class="flex flex-col gap-2 mt-4">
<button id="checkBtn" class="btn bg-indigo-600 text-white">üîç Check</button>
<button id="formatBtn" class="btn bg-emerald-500 text-white">‚öôÔ∏è Auto Fix / Format</button>
<button id="applyFixBtn" class="btn bg-yellow-500 text-white">‚úÖ Apply Fix</button>
</div>
</aside>

<section class="flex-1 flex flex-col gap-3">
<div class="glass p-3 flex items-center justify-between">
<input id="filename" class="bg-transparent outline-none text-lg" value="untitled.js" />
<div class="flex gap-2">
<button id="copyBtn" class="btn glass">Copy</button>
<button id="downloadBtn" class="btn bg-blue-600 text-white">Download</button>
</div>
</div>

<div class="cm-container glass p-3">
<textarea id="editor" style="display:none"></textarea>
<div id="cmEditor"></div>
</div>

<div class="flex gap-3 mt-2">
<div class="flex-1 glass p-3">
<div class="font-semibold">Analysis</div>
<div id="analysis" class="mt-2 text-sm">Press "Check" to analyze.</div>
</div>
<div class="w-80 glass p-3">
<div class="font-semibold">Issues</div>
<div id="issues" class="mt-2 max-h-48 overflow-auto"></div>
</div>
</div>

<div class="status-bar glass mt-2" id="statusBar">
<div id="cursorPos">Line 1, Col 1</div>
<div id="issueCount">0 issues</div>
<div id="autosave">Auto-save On</div>
</div>
</section>
</main>

<footer class="text-center minor p-4">¬© 2025 Ndraa Syntax Pro 2.1 ‚Äî Single-file IDE</footer>
</div>

<script>
// Initialize CodeMirror
const cm = CodeMirror(document.getElementById('cmEditor'),{
  value:'console.log("Hello World");',
  mode:'javascript',
  theme:'dracula',
  lineNumbers:true,
  matchBrackets:true,
  tabSize:2,
  indentUnit:2
});

let currentLang='javascript';
let lastFixed='';
const langSelect=document.getElementById('langSelect');
const fileInput=document.getElementById('fileInput');
const filenameInput=document.getElementById('filename');
const issuesDiv=document.getElementById('issues');
const analysisDiv=document.getElementById('analysis');
const autosaveSpan=document.getElementById('autosave');
let autosaveKey='ndraa_syntax2_draft_v1';

function saveDraft(){
  try{
    localStorage.setItem(autosaveKey,JSON.stringify({
      lang:currentLang,
      filename:filenameInput.value||'untitled',
      content:cm.getValue(),
      ts:Date.now()
    }));
    autosaveSpan.textContent='Auto-save On';
  }catch(e){autosaveSpan.textContent='Auto-save Err';}
}

function loadDraft(){
  try{
    const raw=localStorage.getItem(autosaveKey);
    if(!raw) return;
    const p=JSON.parse(raw);
    setMode(p.lang||'javascript');
    filenameInput.value=p.filename||'untitled';
    cm.setValue(p.content||'');
  }catch(e){}
}

loadDraft();

function setMode(lang){
  currentLang=lang;
  if(lang==='javascript') cm.setOption('mode','javascript');
  else if(lang==='html') cm.setOption('mode','htmlmixed');
  else if(lang==='css') cm.setOption('mode','css');
  langSelect.value=lang;
  saveDraft();
}

// Upload file
fileInput.addEventListener('change', async(ev)=>{
  const f=ev.target.files && ev.target.files[0];
  if(!f) return;
  filenameInput.value=f.name;
  const text=await f.text();
  cm.setValue(text);
  const ext=f.name.split('.').pop().toLowerCase();
  const map={js:'javascript',jsx:'javascript',html:'html',htm:'html',css:'css'};
  setMode(map[ext]||'javascript');
  analysisDiv.textContent='File loaded: '+f.name;
});

// Status bar cursor
cm.on('cursorActivity',()=>{
  const pos=cm.getCursor();
  document.getElementById('cursorPos').textContent=`Line ${pos.line+1}, Col ${pos.ch+1}`;
});

// Analysis
function analyzeCode(code, lang){
  let issues=[];
  if(lang==='javascript'){
    try{esprima.parseScript(code,{tolerant:true,loc:true});}
    catch(err){
      issues.push({title:'JS Syntax Error',message:err.description||err.message,line:err.lineNumber,col:err.column,severity:'error'});
    }
  } else if(lang==='html'){
    const result=HTMLHint.verify(code);
    result.forEach(r=>{
      issues.push({title:'HTML Issue',message:r.message,line:r.line,col:r.col,severity:r.type==='error'?'error':'warn'});
    });
  } else if(lang==='css'){
    try{issues=window.stylelint?window.stylelint.lint({code}).results[0].warnings.map(w=>({title:'CSS Warning',message:w.text,line:w.line,col:w.column,severity:'warn'})) : [];}
    catch(e){}
  }
  return issues;
}

function renderIssues(list){
  issuesDiv.innerHTML='';
  if(!list.length){
    issuesDiv.innerHTML='<div class="text-green-400">No issues found.</div>';
    document.getElementById('issueCount').textContent='0 issues';
    return;
  }
  list.forEach(it=>{
    const el=document.createElement('div');
    el.className='p-2 mb-2 rounded bg-slate-900';
    el.innerHTML=`<div class="${it.severity==='warn'?'issue-warn':'issue-error'} font-semibold">${it.title}</div>
    <div class="text-sm mt-1">Line: ${it.line||'-'} ${it.col? 'Col:'+it.col:''}</div>
    <div class="text-xs mt-1">${it.message}</div>`;
    issuesDiv.appendChild(el);
  });
  document.getElementById('issueCount').textContent=list.length+' issue(s)';
}

// AutoFix / Format
async function autoFix(code,lang){
  let fixed=code;
  try{
    if(lang==='javascript') fixed=prettier.format(code,{parser:'babel',plugins:prettierPlugins});
    else if(lang==='html') fixed=prettier.format(code,{parser:'html',plugins:prettierPlugins});
    else if(lang==='css') fixed=prettier.format(code,{parser:'css',plugins:prettierPlugins});
  }catch(e){analysisDiv.textContent='AutoFix error: '+e.message;}
  return fixed;
}

// Buttons
document.getElementById('checkBtn').addEventListener('click',()=>{
  const code=cm.getValue();
  const issues=analyzeCode(code,currentLang);
  renderIssues(issues);
  analysisDiv.textContent=issues.length?'Found '+issues.length+' issue(s)':'No issues detected';
});

document.getElementById('formatBtn').addEventListener('click', async()=>{
  lastFixed=await autoFix(cm.getValue(),currentLang);
  analysisDiv.textContent='AutoFix ready ‚Äî click Apply Fix';
});

document.getElementById('applyFixBtn').addEventListener('click',()=>{
  if(!lastFixed) return;
  cm.setValue(lastFixed);
  analysisDiv.textContent='Applied fix to editor';
  saveDraft();
});

document.getElementById('copyBtn').addEventListener('click',async()=>{
  try{
    await navigator.clipboard.writeText(cm.getValue());
    analysisDiv.textContent='Copied to clipboard';
  }catch(e){analysisDiv.textContent='Copy failed: '+e.message;}
});

document.getElementById('downloadBtn').addEventListener('click',()=>{
  const content=cm.getValue();
  const name=filenameInput.value||'untitled';
  const ext=name.includes('.')? name.split('.').pop():(currentLang==='javascript'?'js':currentLang==='html'?'html':'css');
  const blob=new Blob([content],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name.includes('.')?name:`${name}.${ext}`;
  a.click();
  URL.revokeObjectURL(a.href);
  analysisDiv.textContent='Downloaded: '+name;
});

langSelect.addEventListener('change',e=>setMode(e.target.value));
setMode('javascript');
</script>
</body>
</html>
"minor mt-1">Saran: ${escapeHtml(it.suggestion || 'Periksa baris yang disebut.')}</div>`;
    issuesDiv.appendChild(el);
  });
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function setMode(lang) {
  currentLang = lang;
  if (lang === 'javascript') cm.setOption('mode','javascript');
  else if (lang === 'html') cm.setOption('mode','htmlmixed');
  else if (lang === 'css') cm.setOption('mode','css');
  else if (lang === 'python') cm.setOption('mode','python');
  else if (lang === 'cpp') cm.setOption('mode','text/x-c++src');
  langSelect.value = lang;
  document.title = `Ndraa Syntax ‚Äî ${lang.toUpperCase()}`;
}

/* ========= Auto-save (localStorage) ========= */
function saveDraft() {
  const payload = {
    lang: currentLang,
    filename: filenameInput.value || 'untitled',
    content: cm.getValue(),
    ts: Date.now()
  };
  try { localStorage.setItem(autosaveKey, JSON.stringify(payload)); document.getElementById('autosaveStatus').textContent = 'On'; }
  catch(e) { document.getElementById('autosaveStatus').textContent = 'Err'; }
}
function loadDraft() {
  try {
    const raw = localStorage.getItem(autosaveKey);
    if (!raw) return;
    const p = JSON.parse(raw);
    setMode(p.lang || 'javascript');
    filenameInput.value = p.filename || 'untitled';
    cm.setValue(p.content || '');
    pushHistory('Loaded draft from localStorage');
  } catch(e){}
}
/* save every 4 seconds while typing */
let saveTimer = null;
cm.on('change', ()=> {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveDraft, 1000 * 4);
});

/* load draft on init */
loadDraft();

/* ========= Upload file handling ========= */
fileInput.addEventListener('change', async (ev)=>{
  const files = Array.from(ev.target.files || []);
  if (!files.length) return;
  const f = files[0];
  filenameInput.value = f.name;
  const text = await f.text();
  cm.setValue(text);
  // detect by extension
  const ext = f.name.split('.').pop().toLowerCase();
  const mapping = { js:'javascript', jsx:'javascript', html:'html', htm:'html', css:'css', py:'python', c:'cpp', cpp:'cpp', h:'cpp' };
  setMode(mapping[ext] || 'javascript');
  pushHistory(`Uploaded ${f.name}`);
});

/* ========= Templates ========= */
document.querySelectorAll('.templateBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.textContent.trim();
    if (t.includes('JS')) {
      setMode('javascript'); filenameInput.value='template.js';
      cm.setValue(`// JS Template\nfunction main(){\n  console.log("Hello from Ndraa Syntax");\n}\nmain();`);
    } else if (t.includes('HTML')) {
      setMode('html'); filenameInput.value='template.html';
      cm.setValue(`<!doctype html>\n<html>\n  <head>\n    <meta charset="utf-8">\n    <title>Template</title>\n  </head>\n  <body>\n    <h1>Ndraa Syntax HTML Template</h1>\n  </body>\n</html>`);
    } else if (t.includes('CSS')) {
      setMode('css'); filenameInput.value='template.css';
      cm.setValue(`/* CSS Template */\n:root{--accent:#7c3aed}\nbody{font-family:Inter,system-ui; background:#0b1220;color:#e6eef8}`);
    } else if (t.includes('Python')) {
      setMode('python'); filenameInput.value='template.py';
      cm.setValue(`# Python template\nprint("Hello Ndraa Syntax")`);
    } else if (t.includes('C++')) {
      setMode('cpp'); filenameInput.value='template.cpp';
      cm.setValue(`#include <iostream>\nusing namespace std;\nint main(){ cout << "Hello"; return 0; }`);
    }
    pushHistory(`Inserted ${t}`);
  });
});

/* ========= Analysis / Lint (lightweight) ========= */
async function analyze(code, lang) {
  const issues = [];
  try {
    if (lang === 'javascript') {
      try {
        // try parse with esprima to catch syntax error
        esprima.parseScript(code, { tolerant: true, loc: true });
      } catch (err) {
        issues.push({ title: 'SyntaxError (JS)', message: err.description || err.message, line: err.lineNumber, col: err.column, severity:'error', suggestion:'Periksa tanda kurung/quote/token sebelum lokasi.'});
      }
      // heuristics
      if (code.includes('console,log')) issues.push({ title:'Typo', message:'console,log ‚Äî kemungkinan maksud console.log', severity:'warn', suggestion:'Ganti menjadi console.log' });
    } else if (lang === 'html') {
      const parser = new DOMParser();
      const doc = parser.parseFromString(code, 'text/html');
      const errEl = doc.querySelector('parsererror');
      if (errEl) issues.push({ title:'Malformed HTML', message: errEl.textContent.slice(0,300), severity:'error', suggestion:'Periksa tag yang terbuka/tertutup.'});
    } else if (lang === 'css') {
      const open = (code.match(/{/g)||[]).length;
      const close = (code.match(/}/g)||[]).length;
      if (open !== close) issues.push({ title:'Unmatched Braces (CSS)', message:`{ count=${open} } count=${close}`, severity:'error', suggestion:'Pastikan setiap { memiliki }.'});
    } else if (lang === 'python') {
      const lines = code.split('\n');
      for (let i=0;i<lines.length;i++){
        if (/^\t+/.test(lines[i])) { issues.push({ title:'Indentation (Python)', message:'Tab detected. Disarankan gunakan spasi (4).', line:i+1, severity:'warn', suggestion:'Ganti tab dengan 4 spasi.'}); break; }
      }
      // bracket / parenthesis basic
      const openP = (code.match(/\(/g)||[]).length;
      const closeP = (code.match(/\)/g)||[]).length;
      if (openP !== closeP) issues.push({ title:'Parenthesis mismatch', message:`(=${openP} )=${closeP}`, severity:'warn', suggestion:'Periksa tanda kurung.'});
    } else if (lang === 'cpp') {
      const lines = code.split('\n');
      let cnt=0;
      for (let i=0;i<lines.length && cnt<15;i++){
        const ln = lines[i].trim();
        if (!ln) continue;
        if (/^(#|\/\/|\/\*|\*|\}|\{)/.test(ln)) continue;
        if (!/;$/.test(ln) && !/\)$/.test(ln) && !/^\b(if|for|while|switch|class|struct|template|namespace)\b/.test(ln)) {
          issues.push({ title:'Possible missing semicolon', line:i+1, message:'Baris ini mungkin butuh ; di akhir', severity:'warn', suggestion:'Tambahkan ; jika pernyataan ekspresi.'});
          cnt++;
        }
      }
    }
  } catch (e) {
    issues.push({ title:'Analyzer Error', message: e.message, severity:'error' });
  }
  return issues;
}

/* ========= Auto-fix (Prettier for js/html/css; heuristics for py/cpp) ========= */
async function autoFix(code, lang) {
  let fixed = code;
  const messages = [];
  let fixesApplied = 0;
  try {
    if (lang === 'javascript') {
      fixed = prettier.format(code, { parser: "babel", plugins: prettierPlugins });
      messages.push('Prettier applied (babel).');
      fixesApplied++;
    } else if (lang === 'html') {
      fixed = prettier.format(code, { parser: "html", plugins: prettierPlugins });
      messages.push('Prettier applied (html).');
      fixesApplied++;
    } else if (lang === 'css') {
      fixed = prettier.format(code, { parser: "css", plugins: prettierPlugins });
      messages.push('Prettier applied (css).');
      fixesApplied++;
    } else if (lang === 'python') {
      // heuristics: tabs -> 4 spaces; trim trailing; basic parentheses balancing
      fixed = code.split('\n').map(l=>l.replace(/\t/g,'    ').replace(/\s+$/,'')).join('\n');
      messages.push('Tabs converted to 4 spaces; trailing spaces trimmed.');
      fixesApplied++;
      const open = (fixed.match(/\(/g)||[]).length;
      const close = (fixed.match(/\)/g)||[]).length;
      if (open > close) { fixed += '\n' + ')'.repeat(open - close); messages.push('Attempted to close extra parentheses.'); fixesApplied++; }
    } else if (lang === 'cpp') {
      // heuristic semicolon insertion for likely statements
      const lines = fixed.split('\n');
      let cnt = 0;
      for (let i=0;i<lines.length;i++){
        const raw = lines[i];
        const ln = raw.trim();
        if (!ln) continue;
        if (/^(#|\/\/|\/\*|\*|\}|\{)/.test(ln)) continue;
        if (/;$/.test(ln)) continue;
        if (!/\)$/.test(ln) && !/;|{|}$/.test(ln) && !/^\b(if|for|while|switch|class|struct|template|namespace)\b/.test(ln)) {
          lines[i] = raw + ';'; cnt++; if (cnt > 200) break;
        }
      }
      fixed = lines.join('\n');
      if (cnt) { messages.push(`Inserted ${cnt} semicolon(s) heuristically.`); fixesApplied += cnt; }
    }
  } catch (e) {
    messages.push('AutoFix error: ' + e.message);
  }
  return { fixed, fixesApplied, messages };
}

/* ========= Button behaviours ========= */
document.getElementById('checkBtn').addEventListener('click', async ()=>{
  const code = cm.getValue();
  const list = await analyze(code, currentLang);
  showIssues(list);
  showAnalysis(list.length ? `${list.length} issue(s) found` : 'No issues. Looks good!');
  statChecks.textContent = String(Number(statChecks.textContent||0) + 1);
  pushHistory(`Check (${currentLang}) ‚Äî ${list.length} issues`);
});

document.getElementById('formatBtn').addEventListener('click', async ()=>{
  const code = cm.getValue();
  const res = await autoFix(code, currentLang);
  lastFixed = res.fixed;
  let msg = `AutoFix done ‚Äî changes: ${res.fixesApplied}. ${res.messages.join(' ‚Ä¢ ')}`;
  showAnalysis(msg);
  // preview fixed snippet
  showIssues([]); // clear issues temporarily
  const pre = document.createElement('pre'); pre.className='minor mt-2'; pre.textContent = res.fixed.slice(0, 10000);
  analysisDiv.innerHTML = ''; analysisDiv.appendChild(document.createTextNode(msg)); analysisDiv.appendChild(pre);
  statFixes.textContent = String(Number(statFixes.textContent||0) + (res.fixesApplied ? 1 : 0));
  pushHistory(`AutoFix (${currentLang}) ‚Äî ${res.fixesApplied} changes`);
});

document.getElementById('applyFixBtn').addEventListener('click', ()=>{
  if (!lastFixed) { showAnalysis('No fixed result ‚Äî run Auto Fix first.'); return; }
  cm.setValue(lastFixed);
  saveDraft();
  pushHistory('Applied fix to editor');
  showAnalysis('Fix applied to editor.');
});

documnor mt-1">Saran: ${escapeHtml(it.suggestion || 'Periksa baris yang disebut.')}</div>`;
    issuesDiv.appendChild(el);
  });
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function setMode(lang) {
  currentLang = lang;
  if (lang === 'javascript') cm.setOption('mode','javascript');
  else if (lang === 'html') cm.setOption('mode','htmlmixed');
  else if (lang === 'css') cm.setOption('mode','css');
  else if (lang === 'python') cm.setOption('mode','python');
  else if (lang === 'cpp') cm.setOption('mode','text/x-c++src');
  langSelect.value = lang;
  document.title = `Ndraa Syntax ‚Äî ${lang.toUpperCase()}`;
}

/* ========= Auto-save (localStorage) ========= */
function saveDraft() {
  const payload = {
    lang: currentLang,
    filename: filenameInput.value || 'untitled',
    content: cm.getValue(),
    ts: Date.now()
  };
  try { localStorage.setItem(autosaveKey, JSON.stringify(payload)); document.getElementById('autosaveStatus').textContent = 'On'; }
  catch(e) { document.getElementById('autosaveStatus').textContent = 'Err'; }
}
function loadDraft() {
  try {
    const raw = localStorage.getItem(autosaveKey);
    if (!raw) return;
    const p = JSON.parse(raw);
    setMode(p.lang || 'javascript');
    filenameInput.value = p.filename || 'untitled';
    cm.setValue(p.content || '');
    pushHistory('Loaded draft from localStorage');
  } catch(e){}
}
/* save every 4 seconds while typing */
let saveTimer = null;
cm.on('change', ()=> {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveDraft, 1000 * 4);
});

/* load draft on init */
loadDraft();

/* ========= Upload file handling ========= */
fileInput.addEventListener('change', async (ev)=>{
  const files = Array.from(ev.target.files || []);
  if (!files.length) return;
  const f = files[0];
  filenameInput.value = f.name;
  const text = await f.text();
  cm.setValue(text);
  // detect by extension
  const ext = f.name.split('.').pop().toLowerCase();
  const mapping = { js:'javascript', jsx:'javascript', html:'html', htm:'html', css:'css', py:'python', c:'cpp', cpp:'cpp', h:'cpp' };
  setMode(mapping[ext] || 'javascript');
  pushHistory(`Uploaded ${f.name}`);
});

/* ========= Templates ========= */
document.querySelectorAll('.templateBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.textContent.trim();
    if (t.includes('JS')) {
      setMode('javascript'); filenameInput.value='template.js';
      cm.setValue(`// JS Template\nfunction main(){\n  console.log("Hello from Ndraa Syntax");\n}\nmain();`);
    } else if (t.includes('HTML')) {
      setMode('html'); filenameInput.value='template.html';
      cm.setValue(`<!doctype html>\n<html>\n  <head>\n    <meta charset="utf-8">\n    <title>Template</title>\n  </head>\n  <body>\n    <h1>Ndraa Syntax HTML Template</h1>\n  </body>\n</html>`);
    } else if (t.includes('CSS')) {
      setMode('css'); filenameInput.value='template.css';
      cm.setValue(`/* CSS Template */\n:root{--accent:#7c3aed}\nbody{font-family:Inter,system-ui; background:#0b1220;color:#e6eef8}`);
    } else if (t.includes('Python')) {
      setMode('python'); filenameInput.value='template.py';
      cm.setValue(`# Python template\nprint("Hello Ndraa Syntax")`);
    } else if (t.includes('C++')) {
      setMode('cpp'); filenameInput.value='template.cpp';
      cm.setValue(`#include <iostream>\nusing namespace std;\nint main(){ cout << "Hello"; return 0; }`);
    }
    pushHistory(`Inserted ${t}`);
  });
});

/* ========= Analysis / Lint (lightweight) ========= */
async function analyze(code, lang) {
  const issues = [];
  try {
    if (lang === 'javascript') {
      try {
        // try parse with esprima to catch syntax error
        esprima.parseScript(code, { tolerant: true, loc: true });
      } catch (err) {
        issues.push({ title: 'SyntaxError (JS)', message: err.description || err.message, line: err.lineNumber, col: err.column, severity:'error', suggestion:'Periksa tanda kurung/quote/token sebelum lokasi.'});
      }
      // heuristics
      if (code.includes('console,log')) issues.push({ title:'Typo', message:'console,log ‚Äî kemungkinan maksud console.log', severity:'warn', suggestion:'Ganti menjadi console.log' });
    } else if (lang === 'html') {
      const parser = new DOMParser();
      const doc = parser.parseFromString(code, 'text/html');
      const errEl = doc.querySelector('parsererror');
      if (errEl) issues.push({ title:'Malformed HTML', message: errEl.textContent.slice(0,300), severity:'error', suggestion:'Periksa tag yang terbuka/tertutup.'});
    } else if (lang === 'css') {
      const open = (code.match(/{/g)||[]).length;
      const close = (code.match(/}/g)||[]).length;
      if (open !== close) issues.push({ title:'Unmatched Braces (CSS)', message:`{ count=${open} } count=${close}`, severity:'error', suggestion:'Pastikan setiap { memiliki }.'});
    } else if (lang === 'python') {
      const lines = code.split('\n');
      for (let i=0;i<lines.length;i++){
        if (/^\t+/.test(lines[i])) { issues.push({ title:'Indentation (Python)', message:'Tab detected. Disarankan gunakan spasi (4).', line:i+1, severity:'warn', suggestion:'Ganti tab dengan 4 spasi.'}); break; }
      }
      // bracket / parenthesis basic
      const openP = (code.match(/\(/g)||[]).length;
      const closeP = (code.match(/\)/g)||[]).length;
      if (openP !== closeP) issues.push({ title:'Parenthesis mismatch', message:`(=${openP} )=${closeP}`, severity:'warn', suggestion:'Periksa tanda kurung.'});
    } else if (lang === 'cpp') {
      const lines = code.split('\n');
      let cnt=0;
      for (let i=0;i<lines.length && cnt<15;i++){
        const ln = lines[i].trim();
        if (!ln) continue;
        if (/^(#|\/\/|\/\*|\*|\}|\{)/.test(ln)) continue;
        if (!/;$/.test(ln) && !/\)$/.test(ln) && !/^\b(if|for|while|switch|class|struct|template|namespace)\b/.test(ln)) {
          issues.push({ title:'Possible missing semicolon', line:i+1, message:'Baris ini mungkin butuh ; di akhir', severity:'warn', suggestion:'Tambahkan ; jika pernyataan ekspresi.'});
          cnt++;
        }
      }
    }
  } catch (e) {
    issues.push({ title:'Analyzer Error', message: e.message, severity:'error' });
  }
  return issues;
}

/* ========= Auto-fix (Prettier for js/html/css; heuristics for py/cpp) ========= */
async function autoFix(code, lang) {
  let fixed = code;
  const messages = [];
  let fixesApplied = 0;
  try {
    if (lang === 'javascript') {
      fixed = prettier.format(code, { parser: "babel", plugins: prettierPlugins });
      messages.push('Prettier applied (babel).');
      fixesApplied++;
    } else if (lang === 'html') {
      fixed = prettier.format(code, { parser: "html", plugins: prettierPlugins });
      messages.push('Prettier applied (html).');
      fixesApplied++;
    } else if (lang === 'css') {
      fixed = prettier.format(code, { parser: "css", plugins: prettierPlugins });
      messages.push('Prettier applied (css).');
      fixesApplied++;
    } else if (lang === 'python') {
      // heuristics: tabs -> 4 spaces; trim trailing; basic parentheses balancing
      fixed = code.split('\n').map(l=>l.replace(/\t/g,'    ').replace(/\s+$/,'')).join('\n');
      messages.push('Tabs converted to 4 spaces; trailing spaces trimmed.');
      fixesApplied++;
      const open = (fixed.match(/\(/g)||[]).length;
      const close = (fixed.match(/\)/g)||[]).length;
      if (open > close) { fixed += '\n' + ')'.repeat(open - close); messages.push('Attempted to close extra parentheses.'); fixesApplied++; }
    } else if (lang === 'cpp') {
      // heuristic semicolon insertion for likely statements
      const lines = fixed.split('\n');
      let cnt = 0;
      for (let i=0;i<lines.length;i++){
        const raw = lines[i];
        const ln = raw.trim();
        if (!ln) continue;
        if (/^(#|\/\/|\/\*|\*|\}|\{)/.test(ln)) continue;
        if (/;$/.test(ln)) continue;
        if (!/\)$/.test(ln) && !/;|{|}$/.test(ln) && !/^\b(if|for|while|switch|class|struct|template|namespace)\b/.test(ln)) {
          lines[i] = raw + ';'; cnt++; if (cnt > 200) break;
        }
      }
      fixed = lines.join('\n');
      if (cnt) { messages.push(`Inserted ${cnt} semicolon(s) heuristically.`); fixesApplied += cnt; }
    }
  } catch (e) {
    messages.push('AutoFix error: ' + e.message);
  }
  return { fixed, fixesApplied, messages };
}

/* ========= Button behaviours ========= */
document.getElementById('checkBtn').addEventListener('click', async ()=>{
  const code = cm.getValue();
  const list = await analyze(code, currentLang);
  showIssues(list);
  showAnalysis(list.length ? `${list.length} issue(s) found` : 'No issues. Looks good!');
  statChecks.textContent = String(Number(statChecks.textContent||0) + 1);
  pushHistory(`Check (${currentLang}) ‚Äî ${list.length} issues`);
});

document.getElementById('formatBtn').addEventListener('click', async ()=>{
  const code = cm.getValue();
  const res = await autoFix(code, currentLang);
  lastFixed = res.fixed;
  let msg = `AutoFix done ‚Äî changes: ${res.fixesApplied}. ${res.messages.join(' ‚Ä¢ ')}`;
  showAnalysis(msg);
  // preview fixed snippet
  showIssues([]); // clear issues temporarily
  const pre = document.createElement('pre'); pre.className='minor mt-2'; pre.textContent = res.fixed.slice(0, 10000);
  analysisDiv.innerHTML = ''; analysisDiv.appendChild(document.createTextNode(msg)); analysisDiv.appendChild(pre);
  statFixes.textContent = String(Number(statFixes.textContent||0) + (res.fixesApplied ? 1 : 0));
  pushHistory(`AutoFix (${currentLang}) ‚Äî ${res.fixesApplied} changes`);
});

document.getElementById('applyFixBtn').addEventListener('click', ()=>{
  if (!lastFixed) { showAnalysis('No fixed result ‚Äî run Auto Fix first.'); return; }
  cm.setValue(lastFixed);
  saveDraft();
  pushHistory('Applied fix to editor');
  showAnalysis('Fix applied to editor.');
});

document
